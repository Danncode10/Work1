# Version 1.4.2.3: Add Route Protection and Redirects (Optional Authentication)

## Date
12/20/2025

## What We Did

### Environment Setup
- No new environment setup required.

### Documentation Updates
- Updated `Docs/Versions/Version 1.md` - Marked sub-stage 4.2.5 checkboxes as completed ([x]).

### Files Created/Modified
- Created `ui/src/utils/auth.js` - Utility for checking user authentication status.
- Created `ui/src/components/AuthRedirect.jsx` - Component to redirect authenticated users from login/register pages.
- Created `ui/src/components/ProtectedRoute.jsx` - Placeholder component for future routes requiring authentication.
- Modified `ui/src/App.jsx` - Integrated `AuthRedirect` component into routing for login and register pages.

## Detailed Explanations

### What is "Optional Authentication Redirects"?
Our goal is to allow users to browse most of the website (like ingredient lists and details) without needing to log in. This is "optional" authentication. However, if a user *is* logged in and tries to go to the "Login" or "Register" page again, it doesn't make sense. So, we automatically redirect them to the home page. This makes the user experience smoother and prevents them from trying to log in when they're already authenticated.

### Files Created

**ui/src/utils/auth.js**
- **Purpose**: This file contains a simple helper function `isAuthenticated()` that checks if the user is currently logged in.
- **How it works**: It looks for an `access_token` in the browser's `localStorage` (a built-in storage area for web applications). If a token exists, it means the user is likely authenticated (which will be confirmed by the backend later).
- **Code Snippet**:
  ```javascript
  // Checks if an 'access_token' is present in local storage
  // If it is, we assume the user is authenticated
  export const isAuthenticated = () => {
    const token = localStorage.getItem('access_token');
    return !!token; // Returns true if token exists, false otherwise
  };
  ```

**ui/src/components/AuthRedirect.jsx**
- **Purpose**: This component acts as a gatekeeper for routes like `/login` and `/register`. If a user who is already authenticated (checked using `isAuthenticated()`) tries to access these pages, this component will automatically send them to the home page (`/`) instead.
- **How it works**: It uses React Router's `Navigate` component to perform the redirect. If the user is *not* authenticated, it simply renders the children components (i.e., the actual `Login` or `Register` form).
- **Code Snippet**:
  ```javascript
  import { Navigate } from 'react-router-dom';
  import { isAuthenticated } from '../utils/auth';

  const AuthRedirect = ({ children }) => {
    if (isAuthenticated()) {
      // If logged in, redirect away from login/register
      return <Navigate to="/" replace />;
    }
    // Otherwise, show the intended component (Login/Register)
    return children;
  };

  export default AuthRedirect;
  ```

**ui/src/components/ProtectedRoute.jsx**
- **Purpose**: This is a placeholder component designed for *future* use. When we eventually have pages that *require* a user to be logged in to access them (e.g., a "My Profile" page), this component will be used to protect those routes.
- **How it works**: Currently, it checks if the user is *not* authenticated; if so, it would redirect them to the `/login` page. For now, no routes are using this, as Version 1 keeps all content publicly browsable.
- **Code Snippet**:
  ```javascript
  import { Navigate } from 'react-router-dom';
  import { isAuthenticated } from '../utils/auth';

  const ProtectedRoute = ({ children }) => {
    if (!isAuthenticated()) {
      // If not logged in, redirect to login page for protected content
      return <Navigate to="/login" replace />;
    }
    // Otherwise, show the protected content
    return children;
  };

  export default ProtectedRoute;
  ```

### Modified Files

**ui/src/App.jsx**
- **Changes Made**: We imported the new `AuthRedirect` component and then wrapped the `<Login />` and `<Register />` routes with it.
- **Why it matters**: This applies the redirect logic described above to these specific routes.
- **Code Snippet**:
  ```diff
  --- a/ui/src/App.jsx
  +++ b/ui/src/App.jsx
  @@ -13,6 +13,7 @@
   import IngredientDetail from './pages/IngredientDetail'
   import Login from './pages/Login'
   import Register from './pages/Register'
  +import AuthRedirect from './components/AuthRedirect'; // New import

   function App() {
     return (
     <Provider store={store}>
       <Router>
         <MainLayout>
           <Routes>
             <Route path="/" element={<Home />} />
             <Route path="/ingredients" element={<Ingredients />} />
             <Route path="/ingredients/:id" element={<IngredientDetail />} />
  -          <Route path="/login" element={<Login />} />
  -          <Route path="/register" element={<Register />} />
  +          <Route path="/login" element={<AuthRedirect><Login /></AuthRedirect>} /> // Wrapped Login
  +          <Route path="/register" element={<AuthRedirect><Register /></AuthRedirect>} /> // Wrapped Register
           </Routes>
         </MainLayout>
       </Router>
  ```
- **Technical Details**: The `element` prop for React Router's `<Route>` can accept other components. By nesting `<Login />` inside `<AuthRedirect>`, `Login` becomes a "child" of `AuthRedirect`, allowing AuthRedirect to control its rendering behavior.

### Routing Flow Diagram (Mermaid)

```mermaid
graph TD
    A[User navigates to URL] --> B{Is URL /login or /register?}
    B -- No --> C[Render as public route]
    B -- Yes --> D{Is user isAuthenticated()?}
    D -- No --> E[Render Login/Register page]
    D -- Yes --> F[Redirect to / (Home page)]
```

## Usage Instructions

### Testing the Redirects
To verify these changes:
1.  **Start Development Server**: Ensure your React app is running by navigating to the `ui` directory in your terminal and running `npm run dev`. This typically runs on `http://localhost:5173`.
2.  **Access as Unauthenticated User**:
    *   Open `http://localhost:5173` in your browser.
    *   Verify you can navigate to `/`, `/ingredients`, `/ingredients/1`, `/login`, and `/register` without any redirects.
3.  **Simulate Authenticated User**:
    *   Open your browser's Developer Tools (usually by pressing **F12** on Windows/Linux or **Cmd + Option + I** on macOS).
    *   Go to the **Application** tab (or **Storage** tab in Safari).
    *   In the left sidebar, expand **Local Storage** and select your application's origin (e.g., `http://localhost:5173`).
    *   Add a new item:
        *   **Key**: `access_token`
        *   **Value**: Paste the long JWT token you received after successfully logging in via the backend (e.g., from your Swagger UI `POST /auth/login` response). Any non-empty string value will suffice for this frontend check.
    *   Refresh the page.
4.  **Test Authenticated Redirect Behavior**:
    *   With the `access_token` still in `localStorage`, try to manually navigate to `http://localhost:5173/login`. You should be immediately redirected to `http://localhost:5173/`.
    *   Repeat for `http://localhost:5173/register`. You should also be redirected to `http://localhost:5173/`.
    *   Confirm that other public routes like `/` or `/ingredients` still load normally.
5.  **Clear Authentication (Optional)**:
    *   Delete the `access_token` entry from `localStorage` in your Developer Tools.
    *   Refresh the page.
    *   You should now be able to access `/login` and `/register` directly again.

## Current Status
- Optional authentication redirect logic is implemented and integrated.
- Placeholder for protected routes is established.
- Documentation for these changes is complete.

## Next Steps
- Proceed to Sub-stage 4.2.6: Establish UI Design System.
